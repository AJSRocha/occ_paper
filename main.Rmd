---
title: "R Notebook"
output: html_notebook
---

# Setup

```{r libraries,message=F}
library(RMySQL)
# library(dbConnect)
library(dplyr)
library(reshape2)
library(openxlsx)
library(ggplot2)
library(RJDBC)
```

```{r connection}
source('con_nautilus.R')
```

```{r info}
info<-dbGetQuery(con,"select * from INFORMATION_SCHEMA.TABLES")

info[info$TABLE_TYPE=="BASE TABLE",] %>%
  select(TABLE_NAME) %>% unique %>% c
```

# Extração de dados

```{sql connection = con, output.var = bio_ceph}
create temporary table batata(
select * from especie_generica p1
  where p1.cod_fao = 'OCC') 
select * from amostra_especie p2
  where p2.especie = batata.id
```

```{sql connection = con, output.var = caca}
select * from amostra_especie p2
 -- where  p2.especie = 'OCC'
```


```{sql connection = con, output.var = porra}
select * from bio_cefalopode p1,
              amostra_especie p2,
              caixa p3,
              denominacao p4
        where p2.especie = 'OCC'
```

```{r}
names(bio_ceph)
bio_ceph %>% filter()
```

# Compra de dados???

```{r}
compra_dados_sppfc <- dbGetQuery(con, readr::read_file('compra_dados_sppfc.sql'))
```

# Conversao pesos OCC

```{r}
lota_pesos_comp_polvos <- dbGetQuery(con, readr::read_file('lota_pesos_comp_polvos.sql'))
```

# Biológicas

```{sql query_bio_16}
--mail de 04.02.2019
select p1.id_viagem,p1.id_amostra,p1.data,to_char(p1.data,'DD-MM-YYYY') data_am,to_char(p1.data,'RRRR') ano,p2.porto_nome,p2.regiao,
p1.arte_eu,p1.cod_fao,p1.matricula,p1.navio,p1.desembarque,p1.peso_am,
p3.cat,p3.peso_a_c,p3.peso_d_c,p3.n_ind,p4.c_classe,p4.indif
from dbm.tbl_amostra p1, dbm.tbl_porto_old p2, dbm.tbl_cat_amostra p3, dbm.tbl_classe_comp p4
where p2.porto_slv=p1.porto_slv and p3.id_amostra=p1.id_amostra and p4.id_cat_amostra=p3.id_cat_amostra
and to_char(p1.data,'RRRR') between 1997 and 2016
and p1.tipo_amostra='C'
and p1.cod_fao in ('OCC','COM','EOI','EDT','SQR','SQC','TDQ','SQM','SQE','CTC')
order by data,porto_nome,matricula,cod_fao,cat,c_classe
;


select p1.id_amostra,p3.ID_BIO_CEFALOPODES,p1.data,to_char(p1.data,'DD-MM-YYYY') data_am,to_char(p1.data,'RRRR') ano,p2.porto_nome,p2.regiao,
p1.arte_eu,p1.cod_fao,p1.matricula,p1.navio,p1.desembarque,p1.peso_am,
p3.N_OBS,p3.C_CLASSE,p3.C_INDIVIDUAL,p3.P_INDIVIDUAL,p3.P_EVISCERADO,p3.SEXO,p3.EST_MATURACAO,p3.E_CALCIFICADA,p3.E_CALCIFICADA_TIPO,p3.E_CALCIFICADA_LIDA_OLD,p3.C_PENIS,
p3.C_TEST,p3.P_TEST,p3.P_CESPERM,p3.P_OVARIO,p3.P_GOVID,p3.D_GOVID,p3.C_GASS,p3.P_GASS,p3.D_GNID,p3.P_GNID,p3.P_COVID,p3.E_ESTOM,p3.P_ESTOM,p3.P_GDIGEST,p3.FECUNDADA,p3.HISTOLOGIA,p3.OBS,p3.C_ESTATOL,
p3.N_ANEIS_HIALINOS,p3.ID_EST_CALCIFICADAS
from dbm.tbl_amostra p1, dbm.tbl_porto_old p2, dbm.tbl_bio_cefalopodes p3
where p2.porto_slv=p1.porto_slv and p3.id_amostra=p1.id_amostra
and to_char(p1.data,'RRRR') between 1997 and 2016
and p1.tipo_amostra='B'
and p1.cod_fao in ('OCC','COM','EOI','EDT','SQR','SQC','TDQ','SQM','SQE','CTC')
order by data,porto_nome,matricula,cod_fao,n_obs,c_classe
```


```{r query_bio_19}
teste <- dbGetQuery(con, readr::read_file('bio_naut.sql'))
```

# Checklist

- [x] Desembarques 1986 - 2019

- [x] Biologicas 1997 - 2016

- [x] Biologicas 2017 - 2019 

- [x] Lotas - 1997 - 2016

- [x] Lotas - 2017 - 2019

- [ ] Respescar scritp dos cephs

- [ ] Procurar ampliaçõe de SOL

# Limpeza de dados

```{r}
load("C:/Google Drive/2021_occ_paper/outputs_queries_naut.Rdata")
```

## Desembarques

```{r}

portos_slv <- read.csv("dados/codigos_portos.csv")
portos_slv[182,] <- c(40950, "CAIS DO BICO", "csbic", "NW","AVEIRO", "PTCDB", "CDB",NA,NA)
```
 
```{r}
# pulpito é o 826
land <- read.csv("PT_land_1986_2019.csv", sep = ";")

land <- 
land %>% 
  filter(SPECIES %in% c("OCC", "OCT")) %>%
  filter(PESQUEIRO == "P") %>%
  transmute(LANDING_COUNTRY = factor(LANDING_COUNTRY),
            HARBOUR = factor(HARBOUR),
            GEAR = factor(GEAR),
            FISHING_5 = factor(FISHING_5),
            SPECIES = factor("OCC"),
            YEAR = factor(YEAR),
            MONTH = factor(MONTH),
            SUB.AREA = factor(SUB.AREA),
            land_kg = LANDINGS_WEIGHT_KG)

land <-
merge(land,
      (portos_slv %>% select(codporto, nome)),
      by.x = "HARBOUR",
      by.y = "codporto",
      all.x = T, all.y = F)

land19 <- read.csv('dados//1_desembarques-mensais_2019.csv', sep = ';', dec = ',')

land19 <-
merge(land19,
      (portos_slv %>% select(codporto, nome)),
      by.x = "PORTO_SLV",
      by.y = "codporto",
      all.x = T, all.y = F)

land19 <-
land19 %>%
  filter(ESPECIE_SLV == 826) %>%
  filter(PESQUEIRO == "N") %>%
  filter(nome!= "PONTA DELGADA (DOCA)") %>%
  # # group_by(ANO, MES, nome, ARTE) %>%
  # summarise(QESTIMADA = sum(QESTIMADA)) %>%
  # ungroup %>%
  transmute(HARBOUR = PORTO_SLV,
            LANDING_COUNTRY = "PRT",
            GEAR = case_when(ARTE == 5 ~ "PS",
                             ARTE == 3 ~ "OTB",
                             ARTE == 13 ~ "MIS"),
            FISHING_5 = "euseila",
            SPECIES = "OCC",
            YEAR = ANO,
            MONTH = MES,
            SUB.AREA = factor(case_when(nome %in% c("VIANA DO CASTELO",
                                                    "CAMINHA",
                                                    "ESPOSENDE",
                                                    "V. PRAIA DA ANCORA",
                                                    "CASTELO DO NEIVA",
                                                    "FAO",
                                                    "POVOA DO VARZIM", 
                                                    "V. CHA",
                                                    "V. CONDE", 
                                                    "MATOSINHOS",
                                                    "ANJEIRAS",
                                                    "AFURADA",
                                                    "AGUDA",
                                                    "ESPINHO",
                                                    "VALBOM",
                                                    "AVEIRO",
                                                    "VAGUEIRA",
                                                    "TORREIRA",
                                                    "MIRA",
                                                    "FURADOURO",
                                                    "CAIS DO BICO",
                                                    "FIGUEIRA DA FOZ") ~ "27.9.a.c.n",
                                        nome %in% c("NAZARE",
                                                    "PENICHE",
                                                    "FOZ DO ARELHO",
                                                    "VIEIRA DE LEIRIA",
                                                    "CASCAIS",
                                                    "SESIMBRA",
                                                    "COSTA DA CAPARICA",
                                                    "TRAFARIA",
                                                    "FONTE DA TELHA",
                                                    "SETUBAL",
                                                    "CARRASQUEIRA",
                                                    "SINES",
                                                    "V. NOVA DE MILFONTES",
                                                    "AZENHA DO MAR",
                                                    "ZAMBUJEIRA") ~ "27.9.a.c.s",
                                        T ~ "27.a.s.a")),
            land_kg = QESTIMADA,
            nome = nome)

rbind(land, land19)

```       



## Biologicas

```{r bio_16}
bio16 <- read.csv("allspp_19972016_bio.csv", sep = ";", dec = ",")

bio16 <- 
bio16 %>%
  filter(COD_FAO == "OCC") %>%
  # filter()
  transmute(ID_AMOSTRA = factor(ID_AMOSTRA),
            DATA = as.POSIXct(DATA_AM, format = '%d-%m-%Y'),
            ANO = factor(ANO),
            PORTO = droplevels(factor(PORTO_NOME)),
            REGIAO = case_when(REGIAO == "N" ~ "27.a.c.n",
                               REGIAO == "C" ~ "27.a.c.s",
                                        TRUE ~ "27.a.s.a"),
            ARTE_EU = factor(ARTE_EU),
            especie_am = factor("OCC"),
            land_kg = DESEMBARQUE, # desembarque da denominação na viagem
            PESO_AM = PESO_AM,
            N_OBS = N_OBS,
            C_CLASSE = C_CLASSE,
            C_INDIVIDUAL = C_INDIVIDUAL,
            P_INDIVIDUAL = P_INDIVIDUAL,
            P_EVISCERADO = P_EVISCERADO,
            SEXO = factor(case_when(SEXO == "F" ~ "F",
                                    SEXO == "f" ~ "F",
                                    SEXO == "M" ~ "M",
                                    SEXO == "m" ~ "M",
                                    TRUE ~ "I")),
            EST_MATURACAO = factor(case_when(EST_MATURACAO == "2         " ~ "2",
                                             EST_MATURACAO == "4         " ~ "4",
                                             EST_MATURACAO == "3         " ~ "3",
                                             EST_MATURACAO == "1         " ~ "1",
                                             EST_MATURACAO == "5         " ~ "5",
                                             EST_MATURACAO == "0         " ~ "0",                                                EST_MATURACAO == "1" ~ "1",
                                             EST_MATURACAO == "2/3       " ~ "2/3",
                                             EST_MATURACAO == "" ~ "NA",
                                             EST_MATURACAO == "1       1 " ~ "1",
                                             EST_MATURACAO == "2" ~ "2",
                                             EST_MATURACAO == "3" ~ "3",
                                             EST_MATURACAO == "5" ~ "5",
                                             EST_MATURACAO == "4" ~ "4")),
            # C_PENIS = C_PENIS,
            # C_TEST = C_TEST,
            P_TEST = P_TEST,
            P_CESPERM = P_CESPERM,
            P_OVARIO = P_OVARIO,
            P_GOVID = P_GOVID,
            D_GOVID = D_GOVID,
            # C_GASS = C_GASS,
            # P_GASS = P_GASS,
            D_GNID = D_GNID,
            # P_GNID = P_GNID,
            # P_COVID = P_COVID,
            E_ESTOM = E_ESTOM,
            P_GDIGEST = P_GDIGEST,
            # FECUNDADA = factor(FECUNDADA)
            ) 

```

```{r bio19 }
bio_naut %>% group_by(ano, trim, estrategia_amostragem) %>%
  summarise(cona = length(unique(id_viagem)))

bio19 <-
bio_naut %>%
  filter(estrategia_amostragem == "Species Focus") %>%
  transmute(id_viagem = factor(id_viagem),
            id_denominacao = factor(id_denominacao),
            id_caixa = factor(id_caixa),
            id_spp = factor(id_spp),
            id_indiv = factor(id_indiv),
            REGIAO = factor( 
              case_when(regiao == "Sul" ~ "27.9.a.s.a",
                               regiao == "SW" ~ "27.9.a.c.s",
                               regiao == "NW" ~ "27.a.c.n")),
            DATA = as.POSIXct(data_venda, format = '%Y-%m-%d'),
            trim = factor(trim),
            ANO = factor(ano),
            PORTO = factor(lota),
            cat_com = factor(cat_com),
            especie_am = factor("OCC"),
            land_kg = peso_total_dom,
            peso_amostrado_dom = peso_amostrado_dom,
            peso_total_caixa = peso_total_caixa,
            peso_am_caixa = peso_am_caixa,
            peso_total_spp = peso_total_spp,
            peso_am_spp = peso_am_spp,
            n_total_caixa = n_total_caixa,
            n_amostrados_caixa = n_amostrados_caixa,
            n_total_spp = n_total_spp,
            n_amostrado_comprimentos = n_amostrado_comprimentos,
            n_nao_observados_tot = n_nao_observados_tot,
            SEXO = factor(sexo),
            E_ESTOM = factor(estado_replecao_estomago),
            EST_MATURACAO = factor(case_when(estado_maturacao == "1 - imatura" ~ 1,
                                       estado_maturacao == "1 - imaturo" ~ 1,
                                       estado_maturacao == "2 - maturação" ~ 2,
                                       estado_maturacao == "3 - matura" ~ 3,
                                       estado_maturacao == "3 - maturo" ~ 3,
                                       estado_maturacao == "4 - postura" ~ 4,
                                       estado_maturacao == "4 - senil" ~ 4,
                                       estado_maturacao == "5 - senil" ~ 5)),
            comp_manto = comp_manto,
            peso_total = peso_total,
            peso_eviscerado = peso_eviscerado,
            m_peso_complex_espermatoforico = m_peso_complex_espermatoforico,
            peso_testiculo = peso_testiculo,
            peso_gland_oviducal = peso_gland_oviducal,
            peso_ovario = peso_ovario,
            peso_gland_digestiva = peso_gland_digestiva) %>%
  filter(DATA <= "2019-12-31")
```

## Lotas

```{r lota16}
lota16 <- read.csv("allspp_19972016_cmp.csv", sep = ";", dec = ",")

lota16 <-
  lota16 %>% 
    filter(COD_FAO == 'OCC') %>%
    transmute(ID_VIAGEM = factor(ID_VIAGEM),
              ID_AMOSTRA = factor(ID_AMOSTRA),
              DATA = as.POSIXct(DATA_AM, format = ('%d-%m-%Y')),
              ANO = factor(ANO),
              PORTO_NOME = factor(PORTO_NOME),
              REGIAO = case_when(REGIAO == "N" ~ "27.a.c.n",
                                 REGIAO == "C" ~ "27.a.c.s",
                                          TRUE ~ "27.a.s.a"),
              ARTE_EU = factor(ARTE_EU),
              COD_FAO = factor('OCC'),
              land_kg = DESEMBARQUE,
              PESO_AM = PESO_AM,
              cat = factor(
                case_when(
                  CAT %in% c("0", "T0", "~0", "T0.", "TO", "T", "TUD", "MIS") ~ "T0",
                  CAT %in% c("1", "T1", "T1*", "T1+") ~ "T1",
                  CAT %in% c("T2", "2", "T2*") ~ "T2",
                  CAT %in% c("3", "T3"," T3","T3R") ~ "T3",
                  CAT %in% c("T4", "4") ~ "T4",
                  CAT %in% c("T5", "5", "T54") ~ "T5",
                  CAT %in% c("T6", "6") ~ "T6",
                  CAT %in% c("P", "P-", "P.") ~ "P",
                  CAT %in% c("MP") ~ "MP",
                  CAT %in% c("M") ~ "M",
                  CAT %in% c("GM") ~ "GM",
                  CAT %in% c("G", "G+") ~ "G",
                  CAT %in% c("999") ~ "tatudouiui")),
              PESO_A_C = PESO_A_C,
              PESO_D_C = PESO_D_C,
              N_IND = N_IND,
              C_CLASSE = C_CLASSE,
              INDIF = INDIF
              )
```


```{r lota19}
lota19 <-
lota_pesos_comp_polvos %>%
            # filter(estrategia_amostragem == "Concurrent Sampling") %>%
            transmute(id_viagem = factor(id_viagem),
                      id_denominacao = factor(id_denominacao),
                      id_caixa = factor(id_caixa),
                      id_spp = factor(id_spp),
                      REGIAO = factor( 
                               case_when(zona == "Sul" ~ "27.9.a.s.a",
                                         zona == "SW" ~ "27.9.a.c.s",
                                         zona == "NW" ~ "27.a.c.n")),
                      DATA = as.POSIXct(data_venda, format = '%Y-%m-%d'),
                      ANO = factor(ano),
                      MES = factor(mes),
                      PORTO = factor(lota),
                      cat_com = factor(cat_com),
                      especie_am = factor("OCC"),
                      land_kg = peso_total_dom,
                      CAT = factor(cat_com),
                      peso_amostrado_dom = peso_amostrado_dom,
                      peso_total_caixa = peso_total_caixa,
                      peso_am_caixa = peso_am_caixa,
                      peso_total_spp = peso_total_spp,
                      peso_am_spp = peso_am_spp,
                      n_total_caixa = n_total_caixa,
                      n_amostrados_caixa = n_amostrados_caixa,
                      n_total_spp = n_total_spp,
                      n_amostrado_comprimentos = n_amostrado_comprimentos,
                      n_nao_observados = n_nao_observados,
                      n_nao_observados_tot = n_nao_observados_tot,
                      classe_comp = classe_comp)
```

# TO DO

- [ ] Verificar outliers nos comprimentos

  * tabela **bio16** alterna entre comprimentos a cm e mm *corrigido*
  * bicho de sagres foi pesado em kg *corrigido*
  * devo um fino ao DD porque ele encontrou o polvo da fuzeta 

- [ ] Uniformizar portos entre as duas tabelas
- [ ] Não temos categoria nos dados SIC; que fazer?
- [ ] Uniformizar pesos e comprimentos na lota 19
- [ ] Ampliações

```{r limpa_bio_16}
cm_mm <- which(bio16$C_INDIVIDUAL < 40)
table(bio16[cm_mm,]$PORTO, bio16[cm_mm,]$ANO)
table(bio16[-cm_mm,]$PORTO, bio16[-cm_mm,]$ANO)

bio16$C_INDIVIDUAL_corr <- bio16$C_INDIVIDUAL
bio16[cm_mm,]$C_INDIVIDUAL_corr <- bio16[cm_mm,]$C_INDIVIDUAL_corr*10

# corrigir pesos registados em kg - 2 obs
bio16[is.na(bio16$P_INDIVIDUAL),]$P_INDIVIDUAL <- 0
bio16[bio16$P_INDIVIDUAL > 0 & bio16$P_INDIVIDUAL < 20,]$P_INDIVIDUAL <- bio16[bio16$P_INDIVIDUAL > 0 & bio16$P_INDIVIDUAL < 20,]$P_INDIVIDUAL * 1000

bio16[is.na(bio16$C_INDIVIDUAL_corr),]$C_INDIVIDUAL_corr <- 0
bio16[bio16$C_INDIVIDUAL_corr == 12.2,]$C_INDIVIDUAL_corr <- 122


  bio16[bio16$C_INDIVIDUAL_corr < 20,]$C_INDIVIDUAL_corr * 10


bio16 %>%
  filter(C_INDIVIDUAL_corr < 500) %>%
  filter(P_INDIVIDUAL > 0) %>%
  # filter(REGIAO == "27.a.s.a") %>%
  ggplot + 
  geom_point(aes(y = C_INDIVIDUAL_corr, x = P_INDIVIDUAL, col = PORTO)) + 
  theme_light() + 
  # geom_hline(aes(yintercept = 40), col = 'red') + 
  # facet_wrap(REGIAO ~ ANO) + 
  theme(legend.position = 'bottom')
```

```{r limpa_bio_19}
bio19 %>%
  ggplot + 
  geom_point(aes(y = comp_manto, x = peso_total, col = PORTO)) + 
  theme_light() + 
  # geom_hline(aes(yintercept = 40), col = 'red') + 
  facet_wrap(REGIAO ~ ANO) + 
  theme(legend.position = 'bottom')

names(bio19)
```

```{r limpa_lota_16}

# viagens filhas da puta em sines, medidas ate ao tentaculo:
# lota16 %>% filter(PORTO_NOME == "SINES" & ANO == 2009) %>%
#   select(ID_VIAGEM,C_CLASSE) %>%
#   group_by(ID_VIAGEM) %>%
#   summarise(ref = min(C_CLASSE))
viag_sines <- c(106841,106857,106876,106931,106897,106930,106915,106835,106921,107703)

lota16 %>%
  filter(!C_CLASSE %in% c(998,999)) %>%
  filter(!ID_VIAGEM %in% viag_sines) %>% 
    ggplot + 
  geom_point(aes(y = PESO_AM, x = C_CLASSE, col = PORTO_NOME)) + 
  theme_light() + 
  # geom_hline(aes(yintercept = 40), col = 'red') + 
  facet_wrap(REGIAO ~ .) + 
  theme(legend.position = 'bottom')
```

```{r amplia_lota16}

# 1 - acrescentamos desembarque da unidade amostral correspondente: EGRUPART x MES x ANO x LOTA

merge((lota16 %>% mutate(MES = format(lota16$DATA, format = '%m'))),
      (land %>% select(nome, GEAR, YEAR, MONTH, land_kg)),
      by.x = c('PORTO_NOME', 'ARTE_EU','ANO', 'MES'),
      by.y = c('nome', 'GEAR', 'YEAR', 'MONTH'),
      all.x = T, all.y = F)
#acabar

lota16 %>%
  group_by(ID_VIAGEM,cat) %>%
  summarise(desemb = unique(land_kg),
            D_C = unique(PESO_D_C)) %>%
  group_by(ID_VIAGEM) %>%
  summarise(desemb = unique(desemb),
            DC = sum(D_C)) %>%
  filter(abs(desemb - DC) > 0.5) %>% View
  

```
* 140 viagens com discrepância: decidir


## Proposta:

Depois de determninar curvas de peso-comprimento, fazer predict das amostragens em lota e comparar com o peso desembarcado da categoria
